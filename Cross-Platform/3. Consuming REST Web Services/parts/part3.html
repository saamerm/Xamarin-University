<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
    <title>Exercise 3: Adding ModernHttpClient</title>
    <link rel="stylesheet" type="text/css" href="./res/styles/normalize.css">
    <link rel="stylesheet" type="text/css" href="./res/styles/prettify.css" />
    <link rel="stylesheet" type="text/css" href="./res/styles/styles.css">
</head>

<body>
    <!-- Use the same title as the StartHere -->
    <header>Consuming RESTful Web Services</header>

    <section id="main">

        <h1 id="page-title"></h1>
        <h2>Duration</h2>
        <p>10 minutes</p>

        <h2>Goals</h2>
        <p>
            In this final group exercise, we will add support to our Book client to use the 3<sup>rd</sup> party ModernHttpClient library. It will behave and run exactly as before, but be more performant and optimized to each platform.
        </p>

        <h2>Exercise Overview</h2>
        <p>
            We will perform the following steps together:
            <ol>
                <li>Add the <b>ModernHttpClient</b> library to all of our projects.</li>
                <li>Change the current <code>HttpClient</code> constructor to use the <b>ModernHttpClient</b> extension.</li>
                <li>Add the proper exclusions for App Transport Security to allow the app to work with iOS9.</li>
            </ol>
        </p>

        <h1>Steps</h1>
        <h2>Add the ModernHttpClient library</h2>
        <p>
            To use the <b>ModernHttpClient</b> library, we need to add a reference to each of our projects. You can either continue from the prior exercise, or use the completed project from the prior exercise if you'd like to start fresh.
        </p>
        <ol>
            <li>
                Add a Nuget package reference to <b>ModernHttpClient</b> to each of the projects. If you are using Visual Studio, you can do this at the solution level by right-clicking on the solution node and selecting &quot;Manage Nuget Packages for Solution&quot;. On Xamarin Studio, you will need to add the packages individually to each project through <b>Add > Add Packages...</b>.
            </li>
            <img src="./res/images/modern-http-client.png" />
            <li>
                It must be added to the PCL library, as well as each of the platform libraries as it changes the implementation on a per-platform basis.
            </li>
        </ol>

        <h2>Use the ModernHttpClient library</h2>
        <p>
            Next, we will change our code to utilize this library.
        </p>
        <ol>
            <li>
                Open the <code>BookManager</code> class and locate the <code>GetClient</code> method where we create the <code>HttpClient</code> instance for all of our operations.
            </li>
            <li>
                Create a <code>NativeMessageHandler</code> instance from the ModernHttpClient library and pass it into the existing <code>HttpClient</code> constructor call.
            </li>
            <li>
                Run the application and verify that it still functions properly. If you are using iOS9 as your testing operating system, then you will get an exception indicating the ATS policy has been violated - go ahead and fix that by completing the next optional section.
            </li>
        </ol>

<p><a href="#" onclick="toggleCode(this,'modernHttpClient');return false;" class="uiitem">Show Code</a><div class="indent-large" id="modernHttpClient" style="display:none;">
<pre class="prettyprint">
private async Task&lt;HttpClient> GetClient()
{
    HttpClient client = new HttpClient(<span class="highlight">new NativeMessageHandler()</span>);
    if (string.IsNullOrEmpty(authorizationKey))
    ...
}
</pre></div></p>


        <h2>(Optional) Add ATS policy exceptions for our endpoint for iOS9</h2>
        <p>
            In this final step, we will add keys into the <b>info.plist</b> for our iOS host application to allow the app to communicate with the book server even though it's not using TLS.
        </p>
        <ol>
            <li>
                Using an XML editor, open the <b>info.plist</b> file in the <b>BookClient.iOS</b> project. You can also use the GUI editor, but because this key is new, it may be difficult to add it in as a custom key until support is in the GUI.
            </li>
            <li>
                At the end of the XML file, just before the final <code>&lt;/dict></code>, add a <code>&lt;key></code> for <code>NSAppTransportSecurity</code> with a child <code>&lt;dict></code> section. Fill it with the following code to setup the exclusion for <code>xam150.azurewebsites.net</code>.
            </li>
        </ol>

<pre class="prettyprint codeblock">
    ...
    &lt;key>UILaunchStoryboardName&lt;/key>
    &lt;string>LaunchScreen&lt;/string>
    &lt;key>CFBundleShortVersionString&lt;/key>
    &lt;string>1.0&lt;/string>
    <span class="highlight">&lt;key>NSAppTransportSecurity&lt;/key>
    &lt;dict>
        &lt;key>NSExceptionDomains&lt;/key>
        &lt;dict>
           &lt;key>xam150.azurewebsites.net&lt;/key>
           &lt;dict>
              &lt;key>NSExceptionMinimumTLSVersion&lt;/key>
              &lt;string>TLSv1.0&lt;/string>
              &lt;key>NSExceptionRequiresForwardSecrecy&lt;/key>
              &lt;false/>
              &lt;key>NSExceptionAllowsInsecureHTTPLoads&lt;/key>
              &lt;true/>
              &lt;key>NSIncludesSubdomains&lt;/key>
              &lt;true/>
           &lt;/dict>
        &lt;/dict>
    &lt;/dict></span>
&lt;/dict>
&lt;/plist>
</pre>
        <ol start="3">
            <li>Run the application a final time nd verify that it is now capable of pulling data for the iOS app with ModernHttpClient enabled.</li>
        </ol>

        <h1>Summary</h1>
        <p>
            Congratulations! We are now using an optimized, platform-specific web client implementation to access our REST based services. Make sure to ask any questions you have and take advantage of the live instructor!
        </p>
        <div class="align-right">
            <a href="../Start%20Here.html">Go Back</a>
        </div>
    </section>

    <script src="./res/js/jquery.min.js"></script>
    <script src="./res/js/prettify.js"></script>
    <script src="./res/js/script.js"></script>

    <footer>Copyright (C) 2016 Xamarin</footer>
</body>
</html>
